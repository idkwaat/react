import React, { useState, useContext } from "react";
import { useCart } from "../context/CartContext";
import { jwtDecode } from "jwt-decode";
import { AuthContext } from "../context/AuthContext";
import PaymentPopup from "../components/PaymentPopup"; // ‚¨ÖÔ∏è th√™m d√≤ng n√†y

const API_BASE_URL = process.env.REACT_APP_API_URL || "http://localhost:5186";

export default function CheckOut() {
  const { cartItems, getCartTotal, clearCart } = useCart();
  const { token } = useContext(AuthContext);

  const [formData, setFormData] = useState({
    fullName: "",
    phone: "",
    email: "",
    province: "",
    district: "",
    ward: "",
    address: "",
    notes: "",
  });

  const [showPopup, setShowPopup] = useState(false);
  const [createdOrder, setCreatedOrder] = useState(null);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  const handlePlaceOrder = async (e) => {
    e.preventDefault();

    if (!token) {
      alert("‚ùå B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng!");
      return;
    }

    try {
      const decoded = jwtDecode(token);

      const order = {
        customerName: formData.fullName,
        phone: formData.phone,
        email: formData.email,
        address: `${formData.address}, ${formData.ward}, ${formData.district}, ${formData.province}`,
        notes: formData.notes,
        paymentMethod: "Chuy·ªÉn kho·∫£n ng√¢n h√†ng",
        totalAmount: getCartTotal(),
        items: cartItems.map((item) => ({
          productId: item.productId,
          variantId: item.variantId || null,
          variantName: item.variantName || null,
          quantity: item.quantity,
          price: item.price,
        })),
      };

      const res = await fetch(`${API_BASE_URL}/api/orders`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(order),
      });

      if (res.ok) {
        const result = await res.json();
        setCreatedOrder(result);
        setShowPopup(true); // ‚úÖ b·∫≠t popup
      } else if (res.status === 401) {
        alert("‚ö†Ô∏è Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
        localStorage.removeItem("token");
      } else {
        const errorText = await res.text();
        console.error("Server error:", errorText);
        alert("‚ùå L·ªói khi t·∫°o ƒë∆°n h√†ng!");
      }
    } catch (err) {
      console.error("L·ªói khi g·ª≠i ƒë∆°n h√†ng:", err);
      alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server ho·∫∑c token l·ªói!");
    }
  };
  return (
    <div className="vs-checkout-wrapper space-top space-extra-bottom">
      <div className="container">
        <form className="checkout-form mt-40" onSubmit={handlePlaceOrder}>
          <div className="row">
            {/* --- TH√îNG TIN NG∆Ø·ªúI NH·∫¨N --- */}
            <div className="col-lg-6">
              <h3>Th√¥ng tin giao h√†ng</h3>
              {[
                { label: "H·ªç v√† t√™n *", name: "fullName" },
                { label: "S·ªë ƒëi·ªán tho·∫°i *", name: "phone" },
                { label: "Email", name: "email", type: "email" },
                { label: "T·ªânh / Th√†nh ph·ªë *", name: "province" },
                { label: "Qu·∫≠n / Huy·ªán *", name: "district" },
                { label: "Ph∆∞·ªùng / X√£ *", name: "ward" },
                { label: "ƒê·ªãa ch·ªâ chi ti·∫øt *", name: "address" },
              ].map((f) => (
                <div className="form-group" key={f.name}>
                  <label>{f.label}</label>
                  <input
                    type={f.type || "text"}
                    name={f.name}
                    value={formData[f.name]}
                    onChange={handleChange}
                    required={f.label.includes("*")}
                  />
                </div>
              ))}
              <div className="form-group">
                <label>Ghi ch√∫</label>
                <textarea
                  name="notes"
                  value={formData.notes}
                  onChange={handleChange}
                ></textarea>
              </div>
            </div>

            {/* --- TH√îNG TIN ƒê∆†N H√ÄNG + THANH TO√ÅN --- */}
            <div className="col-lg-6">
              <h3>Thanh to√°n chuy·ªÉn kho·∫£n</h3>
              <div className="checkout-summary p-3 border rounded">
                <table className="table mb-3 align-middle">
                  <thead className="table-light">
                    <tr>
                      <th style={{ width: "55%" }}>S·∫£n ph·∫©m</th>
                      <th style={{ textAlign: "center", width: "15%" }}>S·ªë l∆∞·ª£ng</th>
                      <th style={{ textAlign: "right", width: "30%" }}>Th√†nh ti·ªÅn</th>
                    </tr>
                  </thead>
                  <tbody>
                    {(!Array.isArray(cartItems) || cartItems.length === 0) ? (
                      <tr>
                        <td colSpan="3" className="text-center py-3 text-muted">
                          Gi·ªè h√†ng tr·ªëng
                        </td>
                      </tr>
                    ) : (
                      cartItems.map((item) => (
                        <tr key={`${item.productId}-${item.variantId || "base"}`} className="border-bottom">
                          <td>
                            <div className="d-flex align-items-center gap-3">
                              <img
                                src={
                                  item.imageUrl?.startsWith("http")
                                    ? item.imageUrl
                                    : `${API_BASE_URL}${item.imageUrl}`
                                }
                                alt={item.productName}
                                style={{
                                  width: "64px",
                                  height: "64px",
                                  objectFit: "cover",
                                  borderRadius: "10px",
                                  boxShadow: "0 0 4px rgba(0,0,0,0.1)"
                                }}
                              />
                              <div>
                                <div style={{ fontWeight: "600", fontSize: "1rem", color: "#333" }}>
                                  {item.productName}
                                </div>
                                {item.variantName && (
                                  <div style={{ fontSize: "0.9em", color: "#777" }}>
                                    <i>Bi·∫øn th·ªÉ:</i> {item.variantName}
                                  </div>
                                )}
                                <div style={{ fontSize: "0.85em", color: "#999" }}>
                                  ƒê∆°n gi√°: {item.price.toLocaleString()}‚Ç´
                                </div>
                              </div>
                            </div>
                          </td>
                          <td style={{ textAlign: "center", fontWeight: "500" }}>{item.quantity}</td>
                          <td style={{ textAlign: "right", fontWeight: "600", color: "#d35400" }}>
                            {(item.price * item.quantity).toLocaleString()}‚Ç´
                          </td>
                        </tr>
                      ))
                    )}
                  </tbody>
                  <tfoot>
                    <tr>
                      <th colSpan="2" style={{ textAlign: "right", fontSize: "1.05rem" }}>T·ªïng c·ªông</th>
                      <th style={{ textAlign: "right", fontSize: "1.05rem", color: "#e74c3c" }}>
                        {Array.isArray(cartItems) && cartItems.length > 0
                          ? getCartTotal().toLocaleString()
                          : 0}
                        ‚Ç´
                      </th>
                    </tr>
                  </tfoot>
                </table>

                <div className="mt-3">
                  <p>Vui l√≤ng thanh to√°n b·∫±ng c√°ch qu√©t m√£ QR sau khi ·∫•n n√∫t x√°c nh·∫≠n:</p>
                  <ul>
                    <li><strong>Ng√¢n h√†ng:</strong> MBBank</li>
                    <li><strong>Ch·ªß t√†i kho·∫£n:</strong> PHUNG CHI KIEN</li>
                    <li>
                      <strong>N·ªôi dung:</strong>{" "}
                      {`Thanh toan don hang #${Date.now()}`}
                    </li>
                  </ul>
                </div>

                <button type="submit" className="vs-btn mt-3 w-100">
                  X√°c nh·∫≠n ƒë·∫∑t h√†ng
                </button>
              </div>
            </div>
          </div>
        </form>

                           {/* üßæ Popup QR thanh to√°n */}
        {createdOrder && (
          <PaymentPopup
            show={showPopup}
            onClose={() => setShowPopup(false)}
            orderId={createdOrder.id}
            amount={createdOrder.totalAmount}
             onPaid={() => clearCart()}
          />
        )}

      </div>
    </div>
  );
}
