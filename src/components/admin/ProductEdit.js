import React, { useEffect, useState } from "react";
import { useParams, useNavigate } from "react-router-dom";

const API_BASE_URL = process.env.REACT_APP_API_URL || "http://localhost:5186";

const ProductEdit = () => {
  const { id } = useParams();
  const navigate = useNavigate();

  const [categories, setCategories] = useState([]);
  const [deletedVariantIds, setDeletedVariantIds] = useState([]);

  const [form, setForm] = useState({
    name: "",
    description: "",
    categoryId: "",
  });

  const [variants, setVariants] = useState([]);

  // üîπ Load danh m·ª•c
  useEffect(() => {
    fetch(`${API_BASE_URL}/api/categories`)
      .then((res) => res.json())
      .then(setCategories)
      .catch((err) => console.error("L·ªói khi load danh m·ª•c:", err));
  }, []);

  // üîπ Load s·∫£n ph·∫©m c·∫ßn s·ª≠a
  useEffect(() => {
    fetch(`${API_BASE_URL}/api/products/${id}`)
      .then((res) => res.json())
      .then((data) => {
        setForm({
          name: data.name,
          description: data.description,
          categoryId: data.categoryId,
        });
        setVariants(
          data.variants?.map((v) => ({
            id: v.id,
            name: v.name,
            price: v.price,
            imageUrl: v.imageUrl,
            modelUrl: v.modelUrl,
            image: null,
            model: null,
            previewImage: null,
          })) || []
        );
      })
      .catch((err) => console.error("L·ªói khi load s·∫£n ph·∫©m:", err));
  }, [id]);

  // üîπ X·ª≠ l√Ω input chung
  const handleChange = (e) => {
    const { name, value } = e.target;
    setForm({ ...form, [name]: value });
  };

  // üîπ X·ª≠ l√Ω thay ƒë·ªïi d·ªØ li·ªáu c·ªßa bi·∫øn th·ªÉ
  const handleVariantChange = (index, field, value) => {
    const updated = [...variants];
    updated[index][field] = value;
    setVariants(updated);
  };

  const handleImageChange = (index, e) => {
    const file = e.target.files[0];
    if (!file) return;
    const updated = [...variants];
    updated[index].image = file;
    updated[index].previewImage = URL.createObjectURL(file);
    setVariants(updated);
  };

  const handleModelChange = (index, e) => {
    const file = e.target.files[0];
    if (!file) return;
    const updated = [...variants];
    updated[index].model = file;
    setVariants(updated);
  };

  const addVariant = () => {
    setVariants([
      ...variants,
      {
        id: null,
        name: "",
        price: "",
        image: null,
        model: null,
        imageUrl: "",
        modelUrl: "",
        previewImage: null,
      },
    ]);
  };

  const removeVariant = (index) => {
    setVariants((prev) => {
      const removed = prev[index];
      if (removed?.id)
        setDeletedVariantIds((prevDel) => [...prevDel, removed.id]);
      return prev.filter((_, i) => i !== index);
    });
  };

  // üîπ G·ª≠i request c·∫≠p nh·∫≠t
  const handleSubmit = async (e) => {
    e.preventDefault();
    const token = localStorage.getItem("token");

    if (!form.name || !form.categoryId) {
      alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n v√† ch·ªçn danh m·ª•c!");
      return;
    }

    const formData = new FormData();
    formData.append("Name", form.name);
    formData.append("Description", form.description);
    formData.append("CategoryId", form.categoryId);
    formData.append("DeletedVariantIds", JSON.stringify(deletedVariantIds));

    // üß© Append d·ªØ li·ªáu bi·∫øn th·ªÉ theo ƒë√∫ng index ƒë·ªÉ backend √°nh x·∫° ƒë√∫ng
    variants.forEach((v, i) => {
      formData.append(`VariantIds[${i}]`, v.id || 0);
      formData.append(`VariantNames[${i}]`, v.name || "");
      formData.append(`VariantPrices[${i}]`, v.price || 0);

      // ·∫¢nh: n·∫øu c√≥ file m·ªõi th√¨ g·ª≠i file, kh√¥ng th√¨ g·ª≠i URL c≈©
      if (v.image instanceof File) {
        formData.append(`VariantImages[${i}]`, v.image);
      } else if (v.imageUrl) {
        formData.append(`VariantImageUrls[${i}]`, v.imageUrl);
      }

      // Model: n·∫øu c√≥ file m·ªõi th√¨ g·ª≠i file, kh√¥ng th√¨ g·ª≠i URL c≈©
      if (v.model instanceof File) {
        formData.append(`VariantModels[${i}]`, v.model);
      } else if (v.modelUrl) {
        formData.append(`VariantModelUrls[${i}]`, v.modelUrl);
      }
    });

    // üßæ Debug xem ƒë√∫ng d·ªØ li·ªáu ch∆∞a
    for (const [key, val] of formData.entries()) {
      console.log(key, val);
    }

    try {
      const res = await fetch(`${API_BASE_URL}/api/products/${id}`, {
        method: "PUT",
        headers: { Authorization: `Bearer ${token}` },
        body: formData,
      });

      if (res.ok) {
        alert("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!");
        navigate("/admin/products");
      } else {
        const errText = await res.text();
        console.error("‚ùå L·ªói khi c·∫≠p nh·∫≠t:", errText);
        alert("‚ùå " + errText);
      }
    } catch (err) {
      console.error("‚ùå L·ªói fetch:", err);
      alert("‚ùå L·ªói k·∫øt n·ªëi m√°y ch·ªß!");
    }
  };
  return (
    <div className="container mt-4">
      <h2>‚úèÔ∏è Ch·ªânh s·ª≠a s·∫£n ph·∫©m</h2>

      <form onSubmit={handleSubmit} encType="multipart/form-data">
        {/* ---- Th√¥ng tin chung ---- */}
        <div className="mb-3">
          <label className="form-label fw-bold">T√™n s·∫£n ph·∫©m</label>
          <input
            type="text"
            name="name"
            className="form-control"
            value={form.name}
            onChange={handleChange}
            required
          />
        </div>

        <div className="mb-3">
          <label className="form-label fw-bold">Danh m·ª•c</label>
          <select
            name="categoryId"
            className="form-select"
            value={form.categoryId}
            onChange={handleChange}
            required
          >
            <option value="">-- Ch·ªçn danh m·ª•c --</option>
            {categories.map((c) => (
              <option key={c.id} value={c.id}>
                {c.name}
              </option>
            ))}
          </select>
        </div>

        <div className="mb-3">
          <label className="form-label fw-bold">M√¥ t·∫£</label>
          <textarea
            name="description"
            className="form-control"
            rows="4"
            value={form.description}
            onChange={handleChange}
            placeholder="Nh·∫≠p m√¥ t·∫£ s·∫£n ph·∫©m..."
          />
        </div>

        <hr />
        <h5>üß© Danh s√°ch bi·∫øn th·ªÉ</h5>

        {variants.map((v, i) => (
          <div key={i} className="border p-3 mb-3 rounded">
            <div className="d-flex justify-content-between align-items-center mb-2">
              <h6>üîπ Bi·∫øn th·ªÉ {i + 1}</h6>
              {v.id && <small className="text-muted">ID: {v.id}</small>}
            </div>

            {(v.previewImage || v.imageUrl) && (
              <div className="mb-2">
                <img
                  src={v.previewImage || 
     (v.imageUrl?.startsWith("http") ? v.imageUrl : `${API_BASE_URL}${v.imageUrl}`)}

                  alt={v.name}
                  style={{
                    width: 100,
                    height: 100,
                    objectFit: "cover",
                    borderRadius: 5,
                  }}
                />
              </div>
            )}

            <label className="form-label">T√™n bi·∫øn th·ªÉ</label>
            <input
              type="text"
              className="form-control mb-2"
              value={v.name}
              onChange={(e) =>
                handleVariantChange(i, "name", e.target.value)
              }
              required
            />

            <label className="form-label">Gi√° (‚Ç´)</label>
            <input
              type="number"
              className="form-control mb-2"
              value={v.price}
              onChange={(e) =>
                handleVariantChange(i, "price", e.target.value)
              }
              required
            />

            <label className="form-label">·∫¢nh bi·∫øn th·ªÉ</label>
            <input
  type="file"
  accept="image/*"
  className="form-control mb-2"
  onChange={(e) => handleImageChange(i, e)}
/>


            <label className="form-label">Model 3D (.glb / .gltf / .fbx)</label>
            <input
  type="file"
  accept=".glb,.gltf,.fbx"
  className="form-control mb-2"
  onChange={(e) => handleModelChange(i, e)}
/>


            <button
              type="button"
              className="btn btn-danger btn-sm mt-2"
              onClick={() => removeVariant(i)}
            >
              üóëÔ∏è X√≥a bi·∫øn th·ªÉ
            </button>
          </div>
        ))}

        <button
          type="button"
          className="btn btn-secondary mb-3"
          onClick={addVariant}
        >
          ‚ûï Th√™m bi·∫øn th·ªÉ
        </button>

        <button type="submit" className="btn btn-primary w-100">
          üíæ L∆∞u thay ƒë·ªïi
        </button>
      </form>
    </div>
  );
};

export default ProductEdit;
