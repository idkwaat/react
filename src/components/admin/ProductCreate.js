import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import axios from "axios";

const API_BASE_URL = process.env.REACT_APP_API_URL || "http://localhost:5186";

const ProductCreate = () => {
  const navigate = useNavigate();
  const [categories, setCategories] = useState([]);
  const [form, setForm] = useState({
    name: "",
    description: "",
    categoryId: "",
  });

  // ‚úÖ Bi·∫øn th·ªÉ c√≥ gi√° ri√™ng
  const [variants, setVariants] = useState([
    { name: "", price: "", image: null, model: null },
  ]);

  // üîπ Load danh m·ª•c
  useEffect(() => {
    fetch(`${API_BASE_URL}/api/categories`)
      .then((res) => res.json())
      .then((data) => setCategories(data))
      .catch((err) => console.error("L·ªói khi load danh m·ª•c:", err));
  }, []);

  // üîπ X·ª≠ l√Ω input chung
  const handleChange = (e) => {
    const { name, value } = e.target;
    setForm({ ...form, [name]: value });
  };

  // üîπ X·ª≠ l√Ω input bi·∫øn th·ªÉ
  const handleVariantChange = (index, field, value) => {
    const newVariants = [...variants];
    newVariants[index][field] = value;
    setVariants(newVariants);
  };

  // üîπ Th√™m bi·∫øn th·ªÉ m·ªõi
  const addVariant = () => {
    setVariants([...variants, { name: "", price: "", image: null, model: null }]);
  };

  // üîπ X√≥a bi·∫øn th·ªÉ
  const removeVariant = (index) => {
    const newVariants = variants.filter((_, i) => i !== index);
    setVariants(newVariants);
  };

  // üîπ G·ª≠i form
const handleSubmit = async (e) => {
  e.preventDefault();
  const token = localStorage.getItem("token");

  if (!form.name || !form.categoryId) {
    alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n v√† ch·ªçn danh m·ª•c!");
    return;
  }

  const formData = new FormData();
  formData.append("Name", form.name);
  formData.append("Description", form.description);
  formData.append("CategoryId", form.categoryId);

variants.forEach((v, index) => {
  formData.append(`VariantNames[${index}]`, v.name || "");
  formData.append(`VariantPrices[${index}]`, v.price || 0);

  // Gi·ªØ th·ª© t·ª± file b·∫±ng c√°ch ch·ªâ append n·∫øu c√≥
  if (v.image) formData.append(`VariantImages[${index}]`, v.image);
  if (v.model) formData.append(`VariantModels[${index}]`, v.model);
});


  try {
    const res = await axios.post(`${API_BASE_URL}/api/products/create`, formData, {
      headers: {
        ...(token ? { Authorization: `Bearer ${token}` } : {}),
        "Content-Type": "multipart/form-data",
      },
    });

    alert("‚úÖ T·∫°o s·∫£n ph·∫©m th√†nh c√¥ng!");
    navigate("/admin/products");
  } catch (err) {
    console.error("‚ùå L·ªói khi th√™m s·∫£n ph·∫©m:", {
      message: err.message,
      status: err.response?.status,
      data: err.response?.data,
    });
    alert(`‚ùå L·ªói khi th√™m s·∫£n ph·∫©m: ${err.response?.data || err.message}`);
  }
};





  return (
    <div className="container mt-4">
      <h2>‚ûï Th√™m s·∫£n ph·∫©m</h2>

      <form onSubmit={handleSubmit} encType="multipart/form-data">
        {/* ---- Th√¥ng tin chung ---- */}
        <input
          name="name"
          className="form-control mb-2"
          placeholder="T√™n s·∫£n ph·∫©m chung (VD: ƒê√®n g·ªó th·ªß c√¥ng)"
          onChange={handleChange}
          required
        />

        <select
          name="categoryId"
          className="form-select mb-2"
          onChange={handleChange}
          required
        >
          <option value="">-- Ch·ªçn danh m·ª•c --</option>
          {categories.map((c) => (
            <option key={c.id} value={c.id}>
              {c.name}
            </option>
          ))}
        </select>

        <textarea
          name="description"
          className="form-control mb-3"
          placeholder="M√¥ t·∫£ s·∫£n ph·∫©m..."
          onChange={handleChange}
        />

        {/* ---- Bi·∫øn th·ªÉ ---- */}
        <h4>üß© Bi·∫øn th·ªÉ s·∫£n ph·∫©m</h4>
        {variants.map((v, i) => (
          <div key={i} className="border rounded p-3 mb-3 bg-light">
            <div className="row">
              <div className="col-md-6 mb-2">
                <input
                  placeholder="T√™n bi·∫øn th·ªÉ (VD: ƒê√®n tr√≤n nh·ªè)"
                  className="form-control"
                  value={v.name}
                  onChange={(e) =>
                    handleVariantChange(i, "name", e.target.value)
                  }
                  required
                />
              </div>

              <div className="col-md-6 mb-2">
                <input
                  type="number"
                  placeholder="Gi√° bi·∫øn th·ªÉ (‚Ç´)"
                  className="form-control"
                  value={v.price}
                  onChange={(e) =>
                    handleVariantChange(i, "price", e.target.value)
                  }
                  required
                />
              </div>
            </div>

            <label className="mt-2">·∫¢nh bi·∫øn th·ªÉ:</label>
            <input
              type="file"
              accept="image/*"
              className="form-control mb-2"
              onChange={(e) =>
                handleVariantChange(i, "image", e.target.files[0])
              }
              required
            />

            <label>File 3D (.glb / .gltf / .fbx):</label>
            <input
              type="file"
              accept=".glb,.gltf,.fbx"
              className="form-control mb-2"
              onChange={(e) =>
                handleVariantChange(i, "model", e.target.files[0])
              }
            />

            {variants.length > 1 && (
              <button
                type="button"
                className="btn btn-danger btn-sm mt-2"
                onClick={() => removeVariant(i)}
              >
                üóëÔ∏è X√≥a bi·∫øn th·ªÉ
              </button>
            )}
          </div>
        ))}

        <button
          type="button"
          onClick={addVariant}
          className="btn btn-secondary mb-3"
        >
          ‚ûï Th√™m bi·∫øn th·ªÉ
        </button>

        <button type="submit" className="btn btn-primary w-100">
          üíæ L∆∞u s·∫£n ph·∫©m
        </button>
      </form>
    </div>
  );
};

export default ProductCreate;
