import React, { useEffect, useState } from "react";
import { Link } from "react-router-dom";
import ModelViewer from "../../components/ModelViewer";

const API_BASE_URL = process.env.REACT_APP_API_URL || "http://localhost:5186";

const ProductList = () => {
  const [products, setProducts] = useState([]);

  const fetchProducts = async () => {
    try {
      const res = await fetch(`${API_BASE_URL}/api/products`);
      if (!res.ok) throw new Error("L·ªói khi t·∫£i danh s√°ch s·∫£n ph·∫©m");
      const data = await res.json();

      // ‚úÖ L·∫•y ƒë√∫ng danh s√°ch s·∫£n ph·∫©m
      setProducts(data.data || []);
    } catch (err) {
      console.error(err);
      alert("‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m t·ª´ server!");
    }
  };


  useEffect(() => {
    fetchProducts();
  }, []);

  const handleDelete = async (id) => {
    if (!window.confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh√¥ng?")) return;
    const token = localStorage.getItem("token");

    try {
      const res = await fetch(`${API_BASE_URL}/api/products/${id}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` },
      });

      if (res.ok) {
        alert("‚úÖ ƒê√£ x√≥a th√†nh c√¥ng!");
        fetchProducts();
      } else {
        alert("‚ùå X√≥a th·∫•t b·∫°i!");
      }
    } catch (err) {
      alert("‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server.");
    }
  };

  return (
    <div className="container mt-4">
      <div className="d-flex justify-content-between align-items-center mb-3">
        <h2 className="m-0">üì¶ Danh s√°ch s·∫£n ph·∫©m</h2>
        <Link to="/admin/products/create" className="btn btn-primary">
          ‚ûï Th√™m s·∫£n ph·∫©m
        </Link>
      </div>

      <div className="table-responsive">
        <table className="table table-bordered align-middle text-center">
          <thead className="table-light">
            <tr>
              <th style={{ width: "50px" }}>ID</th>
              <th>T√™n s·∫£n ph·∫©m</th>
              <th>Bi·∫øn th·ªÉ (·∫¢nh & Model)</th>
              <th>Danh m·ª•c</th>
              <th>M√¥ t·∫£</th>
              <th style={{ width: "150px" }}>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody>
            {products.length > 0 ? (
              products.map((p) => (
                <tr key={p.id}>
                  <td>{p.id}</td>
                  <td className="fw-semibold">{p.name}</td>

                  {/* Bi·∫øn th·ªÉ */}
                  <td>
                    {p.variants && p.variants.length > 0 ? (
                      <div
                        style={{
                          display: "flex",
                          flexWrap: "wrap",
                          justifyContent: "center",
                          gap: "15px",
                        }}
                      >
                        {p.variants.map((v) => (
                          <div
                            key={v.id}
                            style={{
                              border: "1px solid #ddd",
                              borderRadius: "10px",
                              padding: "10px",
                              width: "160px",
                              background: "#fafafa",
                              boxShadow: "0 2px 4px rgba(0,0,0,0.05)",
                            }}
                          >
                            <div style={{ fontWeight: 500, marginBottom: "6px" }}>
                              {v.name.replace(`${p.name} - `, "")}
                            </div>

                            {v.imageUrl ? (
                              <div
                                style={{
                                  width: "100%",
                                  aspectRatio: "1 / 1", // ‚úÖ khung vu√¥ng
                                  borderRadius: "10px",
                                  overflow: "hidden",
                                  background: "#f8f8f8",
                                  display: "flex",
                                  alignItems: "center",
                                  justifyContent: "center",
                                  border: "1px solid #eee",
                                  marginBottom: "8px",
                                }}
                              >
                                <img
                                  src={`${API_BASE_URL}${v.imageUrl}`}
                                  alt={v.name}
                                  style={{
                                    width: "100%",
                                    height: "100%",
                                    objectFit: "cover", // gi·ªØ t·ªâ l·ªá, l·∫•p khung
                                  }}
                                />
                              </div>
                            ) : (
                              <div
                                style={{
                                  width: "100%",
                                  aspectRatio: "1 / 1",
                                  borderRadius: "10px",
                                  background: "#f0f0f0",
                                  display: "flex",
                                  alignItems: "center",
                                  justifyContent: "center",
                                  color: "#aaa",
                                  fontSize: "0.9rem",
                                  marginBottom: "8px",
                                }}
                              >
                                Kh√¥ng ·∫£nh
                              </div>
                            )}

                            {v.modelUrl ? (
                              <div
                                style={{
                                  width: "100%",
                                  aspectRatio: "1 / 1", // ‚úÖ khung vu√¥ng
                                  borderRadius: "10px",
                                  background: "#fff",
                                  border: "1px solid #ddd",
                                  overflow: "hidden",
                                  position: "relative",
                                }}
                              >
                                <model-viewer
                                  src={`${API_BASE_URL}${v.modelUrl}`}
                                  camera-controls
                                  auto-rotate
                                  style={{
                                    width: "100%",
                                    height: "100%",
                                    objectFit: "contain",
                                    background: "transparent",
                                    position: "absolute",
                                    top: 0,
                                    left: 0,
                                  }}
                                />
                              </div>
                            ) : (
                              <div
                                style={{
                                  width: "100%",
                                  aspectRatio: "1 / 1",
                                  borderRadius: "10px",
                                  background: "#f3f3f3",
                                  display: "flex",
                                  alignItems: "center",
                                  justifyContent: "center",
                                  color: "#aaa",
                                  fontSize: "0.9rem",
                                }}
                              >
                                Kh√¥ng c√≥ model
                              </div>
                            )}

                          </div>
                        ))}
                      </div>
                    ) : (
                      <i>Kh√¥ng c√≥ bi·∫øn th·ªÉ</i>
                    )}
                  </td>

                  <td>{p.categoryName || "-"}</td>

                  <td
                    style={{
                      maxWidth: "200px",
                      whiteSpace: "nowrap",
                      overflow: "hidden",
                      textOverflow: "ellipsis",
                    }}
                    title={p.description}
                  >
                    {p.description || "-"}
                  </td>

                  <td>
                    <div className="d-flex justify-content-center gap-2">
                      <Link
                        to={`/admin/products/edit/${p.id}`}
                        className="btn btn-sm btn-warning"
                      >
                        ‚úèÔ∏è S·ª≠a
                      </Link>
                      <button
                        className="btn btn-sm btn-danger"
                        onClick={() => handleDelete(p.id)}
                      >
                        üóëÔ∏è X√≥a
                      </button>
                    </div>
                  </td>
                </tr>
              ))
            ) : (
              <tr>
                <td colSpan="6" className="text-center py-4">
                  üí§ Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

export default ProductList;
